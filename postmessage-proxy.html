<!DOCTYPE html>
<meta charset="utf-8">
<title>PostMessage Proxy</title>
<p>You should not see this text.</p>
<script src="postmessage-proxied-xhr.js"></script>
<script src="settings.js"></script>
<script>
var utils = PostMessageProxiedXHR.utils;

if (window.parent !== window) {
  var origin = Settings.allowOrigin;
  var channel = utils.SimpleChannel(window.parent, origin, function(data) {
    switch (data.cmd) {
      case "send":
      // TODO: Validate URL, ensure it's on our domain.
      var req = new XMLHttpRequest();
      var headers = utils.decode(data.headers);
      var isValidMethod = (utils.inArray(data.method.toUpperCase(),
                                         Settings.allowMethods) != -1);

      if (!isValidMethod) {
        utils.error("method '" + data.method + "' is not allowed");
        return;
      }
      
      req.open(data.method, data.url);
      req.onreadystatechange = function() {
        channel.send({
          cmd: "readystatechange",
          readyState: req.readyState,
          status: req.status,
          statusText: req.statusText,
          responseText: req.responseText
        });
      };
      
      for (var name in headers) {
        if (utils.inArray(name, Settings.allowHeaders) != -1)
          req.setRequestHeader(name, headers[name]);
        else {
          utils.error("header '" + name + "' is not allowed.");
          return;
        }
      }
      
      req.send(data.body || null);
      break;
    }
  });
  channel.send({cmd: "ready"});
}
</script>
