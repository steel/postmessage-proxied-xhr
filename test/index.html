<!DOCTYPE html>
<meta charset="utf-8">
<title>PostMessageProxiedXHR Unit Tests</title>
<link rel="stylesheet" href="qunit.css">
<script src="qunit.js"></script>
<script src="../postmessage-proxied-xhr.js"></script>
<h1 id="qunit-header">PostMessageProxiedXHR Unit Tests</h1>
<h2 id="qunit-banner"></h2>
<div id="qunit-testrunner-toolbar"></div>
<h2 id="qunit-userAgent"></h2>
<ol id="qunit-tests"></ol>
<div id="qunit-fixture"></div>
<script>
module("general");

var utils = PostMessageProxiedXHR.utils;
var PMProxiedXMLHttpRequest = PostMessageProxiedXHR.buildConstructor("../");

test("utils.encode() works", function() {
  deepEqual(utils.encode({a: 'foo', b: 'blarg'}), "a=foo&b=blarg");
  deepEqual(utils.encode({a: '', b: 'blarg'}), "a=&b=blarg");
  deepEqual(utils.encode({a: 'foo&', b: 'b'}), "a=foo%26&b=b",
            "Ensure '&' is encoded properly");
});

test("utils.decode() works", function() {
  deepEqual(utils.decode("a=foo&b=blarg"), {a: 'foo', b: 'blarg'});
  deepEqual(utils.decode("a=&b=blarg"), {a: '', b: 'blarg'});
  deepEqual(utils.decode("a=foo%26&b=b"), {a: 'foo&', b: 'b'},
            "Ensure '&' is decoded properly");
});

test("Response '200 OK' works", function() {
  var req = PMProxiedXMLHttpRequest();
  req.open("get", "test/sample.txt");
  req.onreadystatechange = function() {
    equal(typeof(req.responseText), 'string', 'responseText is a string');
    equal(typeof(req.statusText), 'string', 'statusText is a string');
    equal(typeof(req.status), 'number', 'status is a number');
    equal(typeof(req.readyState), 'number', 'readyState is a number');
    if (req.readyState == 4 && req.status == 200) {
      equal(req.responseText, "hello there, I am sample text.",
            "responseText is as expected.");
      start();
    }
  };
  req.send(null);
  stop();
});

test("Response '404 Not Found' works", function() {
  var req = PMProxiedXMLHttpRequest();
  req.open("get", "nonexistent.txt");
  req.onreadystatechange = function() {
    if (req.readyState == 4 && req.status == 404) {
      ok(true, "Status 404 was returned.");
      start();
    }
  };
  req.send(null);
  stop();
});
</script>
