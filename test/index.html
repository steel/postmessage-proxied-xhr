<!DOCTYPE html>
<meta charset="utf-8">
<title>PostMessageProxiedXHR Unit Tests</title>
<link rel="stylesheet" href="qunit.css">
<script src="qunit.js"></script>
<script src="jquery.min.js"></script>
<script src="../postmessage-proxied-xhr.js"></script>
<script src="../postmessage-proxied-xhr.jquery.js"></script>
<h1 id="qunit-header">PostMessageProxiedXHR Unit Tests</h1>
<h2 id="qunit-banner"></h2>
<div id="qunit-testrunner-toolbar"></div>
<h2 id="qunit-userAgent"></h2>
<ol id="qunit-tests"></ol>
<div id="qunit-fixture"></div>
<script>
module("utils");

var utils = PPX.utils;

test("utils.inArray() works", function() {
  equal(utils.inArray("foo", ["bar", "foo", "baz"]), 1);
  ok(utils.inArray("foo", ["bar", "baz"]), -1);
});

test("utils.encode() works", function() {
  deepEqual(utils.encode({a: 'foo', b: 'blarg'}), "a=foo&b=blarg");
  deepEqual(utils.encode({a: '', b: 'blarg'}), "a=&b=blarg");
  deepEqual(utils.encode({a: 'foo&', b: 'b'}), "a=foo%26&b=b",
            "Ensure '&' is encoded properly");
});

test("utils.decode() works", function() {
  deepEqual(utils.decode("a=foo&b=blarg"), {a: 'foo', b: 'blarg'});
  deepEqual(utils.decode("a=&b=blarg"), {a: '', b: 'blarg'});
  deepEqual(utils.decode("a=foo%26&b=b"), {a: 'foo&', b: 'b'},
            "Ensure '&' is decoded properly");
});

test("utils.isSameOrigin() works", function() {
  ok(utils.isSameOrigin("http://foo.com/bar", "http://foo.com/baz"));
  ok(!utils.isSameOrigin("http://foo.com/bar", "https://foo.com/baz"));  
  ok(!utils.isSameOrigin("http://a.com/", "http://b.com/"));  
  ok(!utils.isSameOrigin("http://a.com:8000/", "http://a.com/"));  
});

module("request");

var Request = PPX.buildClientConstructor("server.html");

test("exception raised if send() called before open()", function() {
  raises(function() {
    var req = Request();
    req.send(null);
  }, new RegExp("request not initialized"));
});

test("method not allowed error works", function() {
  var req = Request();
  req.open("put", "sample.txt");
  req.onreadystatechange = function() {
    equal(req.readyState, req.DONE);
    equal(req.responseText, "method 'put' is not allowed.");
    start();
  };
  req.send(null);
  stop();
});

test("same origin violation error works", function() {
  var req = Request();
  req.open("get", "http://example.com/foo");
  req.onreadystatechange = function() {
    equal(req.readyState, req.DONE);
    equal(req.responseText, "url does not have same origin: http://example.com/foo");
    start();
  };
  req.send(null);
  stop();
});

test("header not allowed error works", function() {
  var req = Request();
  req.open("get", "sample.txt");
  req.setRequestHeader('X-blarg', 'hi');
  req.onreadystatechange = function() {
    equal(req.readyState, req.DONE);
    equal(req.responseText, "header 'X-blarg' is not allowed.");
    start();
  };
  req.send(null);
  stop();
});

test("abort() works", function() {
  var req = Request();
  var readyStates = [];
  req.open("get", "sample.txt");
  equal(req.readyState, 1);
  req.send(null);
  req.onreadystatechange = function() {
    readyStates.push(req.readyState);
  };
  equal(req.readyState, 1);
  req.abort();
  equal(req.readyState, 0);
  deepEqual(readyStates, [4]);
});

test("response '200 OK' works", function() {
  function checkTypes() {
    equal(typeof(req.responseText), 'string', 'responseText is a string');
    equal(typeof(req.statusText), 'string', 'statusText is a string');
    equal(typeof(req.status), 'number', 'status is a number');
    equal(typeof(req.readyState), 'number', 'readyState is a number');
    if (req.readyState >= req.HEADERS_RECEIVED)
      ok(req.getAllResponseHeaders().length,
         'getAllResponseHeaders() returns a non-empty string');
    else
      equal(typeof(req.getAllResponseHeaders()), 'string',
            'getAllResponseHeaders() returns a string');
  }
  
  var req = Request();
  req.open("get", "sample.txt");
  req.onreadystatechange = function() {
    checkTypes();
    if (req.readyState == 4 && req.status == 200) {
      equal(req.responseText, "hello there, I am sample text.",
            "responseText is as expected.");
      start();
    }
  };
  checkTypes();
  req.send(null);
  stop();
});

test("response '404 Not Found' works", function() {
  var req = Request();
  req.open("get", "nonexistent.txt");
  req.onreadystatechange = function() {
    if (req.readyState == 4 && req.status == 404) {
      ok(true, "Status 404 was returned.");
      start();
    }
  };
  req.send(null);
  stop();
});

module("jquery-plugin");

jQuery.proxyAjaxThroughPostMessage("server.html");

test("success works", function() {
  jQuery.ajax({
    url: "sample.txt",
    usePostMessage: true,
    success: function(data, textStatus, req) {
      ok(req.isProxiedThroughPostMessage);
      equal(data, "hello there, I am sample text.");
      start();
    }
  });
  stop();
});

test("error works for 404", function() {
  jQuery.ajax({
    url: "nonexistent.txt",
    usePostMessage: true,
    error: function(req) {
      ok(req.isProxiedThroughPostMessage);
      equal(req.status, 404);
      start();
    }
  });
  stop();
});

test("error works for header not allowed", function() {
  jQuery.ajax({
    url: "nonexistent.txt",
    usePostMessage: true,
    headers: {'X-blarg': 'hi'},
    error: function(req) {
      ok(req.isProxiedThroughPostMessage);
      equal(req.status, 0);
      equal(req.responseText, "header 'X-blarg' is not allowed.");
      start();
    }
  });
  stop();
});
</script>
